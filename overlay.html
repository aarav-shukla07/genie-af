<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Genie AI</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      pointer-events: none;
    }

    #genieBox {
      position: fixed;
      top: 50px;
      right: 50px;
      width: 450px;
      height: 600px;
      background: rgba(0,0,0,0.85);
      color: white;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      overflow: hidden;
      resize: both;
      pointer-events: auto;
    }

    #header {
      background: rgba(0,0,0,0.9);
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      cursor: move;
      pointer-events: auto;
    }

    #chatWindow {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      pointer-events: auto;
    }

    .msg {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 75%;
      white-space: pre-wrap;
    }

    .user { background: rgba(0, 150, 255, 0.7); margin-left: auto; }
    .ai { background: rgba(0, 255, 150, 0.7); margin-right: auto; }

    #inputArea {
      display: flex;
      padding: 8px;
      background: rgba(0,0,0,0.8);
      pointer-events: auto;
    }

    #userInput {
      flex: 1;
      resize: none;
      border-radius: 6px;
      padding: 6px;
      border: none;
      outline: none;
    }

    #sendBtn, #screenshotBtn {
      margin-left: 6px;
      padding: 0 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    #sendBtn { background: #4CAF50; color: white; }
    #sendBtn:hover { background: #45a049; }

    #screenshotBtn { background: #f39c12; color: white; }
    #screenshotBtn:hover { background: #e67e22; }
  </style>
</head>
<body>
  <div id="genieBox">
    <div id="header">✨ Genie — Ask me or Screenshot!</div>
    <div id="chatWindow"><em>Start by asking a question, or click 📸</em></div>
    <div id="inputArea">
      <textarea id="userInput" rows="1" placeholder="Type here..."></textarea>
      <button id="sendBtn">Send</button>
      <button id="screenshotBtn">📸</button>
    </div>
  </div>

  <script>
    const chatWindow = document.getElementById('chatWindow');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const screenshotBtn = document.getElementById('screenshotBtn');
    const genieBox = document.getElementById("genieBox");
const header = document.getElementById("header");
let offsetX, offsetY, isDragging = false;

header.addEventListener("mousedown", e => {
  isDragging = true;
  offsetX = e.clientX - genieBox.offsetLeft;
  offsetY = e.clientY - genieBox.offsetTop;
});

document.addEventListener("mousemove", e => {
  if (isDragging) {
    genieBox.style.left = (e.clientX - offsetX) + "px";
    genieBox.style.top = (e.clientY - offsetY) + "px";
  }
});

document.addEventListener("mouseup", () => {
  isDragging = false;
});


    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;
      chatWindow.appendChild(div);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage() {
      const prompt = input.value.trim();
      if (!prompt) return;
      appendMessage("user", prompt);
      input.value = "";

      appendMessage("ai", "⏳ Thinking...");
      const placeholders = chatWindow.querySelectorAll(".ai");
      const lastAi = placeholders[placeholders.length-1];

      try {
        const answer = await window.overlay.askAI(prompt);
        lastAi.textContent = answer;
      } catch (err) {
        lastAi.textContent = "❌ Error: " + err.message;
      }
    }

    async function explainScreenshot() {
      appendMessage("user", "📸 Screenshot taken — explain this!");
      appendMessage("ai", "✨ Genie is finding...");

      const placeholders = chatWindow.querySelectorAll(".ai");
      const lastAi = placeholders[placeholders.length-1];

      try {
        const extractedText = await window.overlay.captureAndExtract();
        const explanation = await window.overlay.askAI(
          "Explain this content in detail:\n" + extractedText
        );
        lastAi.textContent = explanation;
      } catch (err) {
        lastAi.textContent = "❌ Screenshot error: " + err.message;
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    screenshotBtn.addEventListener("click", explainScreenshot);
  </script>
</body>
</html>
